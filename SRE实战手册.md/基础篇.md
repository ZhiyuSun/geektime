# 基础篇

## 开篇词｜SRE是解决系统稳定性问题的灵丹妙药吗？

要想系统地做好稳定性这件事儿，SRE 就是必修科目。

所以，我系统梳理了自己的经验和调研，打磨出这个课程，目的就是帮你构建起体系化建设 SRE 的思路。

第一部分，夯实基础，带你建立 SRE 稳定性标准。

第二部分，SRE 最佳实践。

精彩评论：
一直在看找老师的书，这次就当听书了，看了下精选留言，分享下目前我的认知：DevOps核心是做全栈交付，SRE的核心是稳定性保障，关注业务所有活动，两者的共性是：都使用软件工程解决问题;
DevOps的诞生是由于互联网商业市场竞争加剧，企业为减少试错成本，往往仅推出最小可行产品，产品需要不断且高频的迭代来满足市场需求，抢占市场(产品的迭代是关乎一整条交付链的事)，高频的迭代则会促使研发团队使用敏捷模式，敏捷模式下对运维的全栈交付能力要求更严格，则运维必须开启DevOps来实现全栈交付；因为不断的迭代交付(也就是俗称的变更)是触发故障，非稳定性根源，而互联网产品/服务稳定性缺失会造成用户流失，甚至流到竞争对手那里， 因此关注业务稳定性也变得十分重要，SRE由此诞生。希望看完赵老师的课程后对理论能有所提升。

## 01｜SRE迷思：无所不能的角色？还是运维的升级？

### SRE，我们应该怎么来理解它？

https://static001.geekbang.org/resource/image/31/f6/31144fb00cf21005a8d0ae3dc02378f6.jpg

这些能力之间的相互依赖，就决定了从职能分工上，SRE 体系的建设绝不是单个岗位或单个部门就能独立完成的，必然要求有高效的跨团队组织协作才可以。

总结一下，从实践角度来看，SRE 的力量不能通过一个岗位、一个或几个技术就发挥出来。SRE 是一个体系化工程，它需要协同多个部门、多项技术。

### 做好 SRE 的根本目的是什么？

从业界稳定性通用的衡量标准看，有两个非常关键的指标：
- MTBF，Mean Time Between Failure，平均故障时间间隔。
- MTTR，Mean Time To Repair， 故障平均修复时间。

到了这里，我们也就明白了，如果想提升稳定性，就会有两个方向：提升 MTBF，也就是减少故障发生次数，提升故障发生间隔时长；降低 MTTR，故障不可避免，那就提升故障处理效率，减少故障影响时长。

https://static001.geekbang.org/resource/image/95/29/9542c5c234c8332f22a9f18b0707cf29.jpg

现在，我们再来看 SRE 稳定性保障规划这张图，你就会理解，为什么要把所做的事情分组分块呈现。目的就是区分清楚，我们做的任何一件事情、开发的任何一套系统、引入的任何一个理念和方法论，有且只有一个目标，那就是“提升 MTBF，降低 MTTR”，也就是把故障发生时间的间隔变长，将故障影响的时间减少。

### 总结

第一，我们需要从全局的角度去理解 SRE。SRE 一定是靠整个技术和组织体系发挥作用的，单纯从某个技术点或环节出发，都无法呈现出效果，也就是说 SRE 一定要从全局考虑，体系一定要“配套”。

第二，SRE 的目的，本质上是减少故障时间，增加系统正常运行时间，也就是 “减少故障，提升 MTBF；同时，提升故障处理效率，降低 MTTR”。SRE 要做的所有事儿，都是为这两个目标服务的。

### 精彩评论

DevOps主要是以驱动价值交付为主，搭建企业内部的功效平台。
SRE主要需要协调多团队合作来提高稳定性。
例如：
- 与开发和业务团队落实降级
- 在开发和测试团队内推动混沌工程落地
- 与开发团队定制可用性衡量标准
- 与开发，测试，devops，产品团队，共同解决代码质量和需求之间的平衡问题。

## 02 | 系统可用性：没有故障，系统就一定是稳定的吗？

### 衡量系统可用性的 2 种方式

那我就直接给答案了，目前业界有两种衡量系统可用性的方式，一个是时间维度，一个是请求维度，我们先来看这两个维度的计算公式。

- 时间维度：Availability = Uptime / (Uptime + Downtime)
- 请求维度：Availability = Successful request / Total request

时长维度，是从故障角度出发对系统稳定性进行评估。

请求维度，是从成功请求占比的角度出发，对系统的稳定性进行评估。

### 设定系统稳定性目标要考虑的 3 个因素

第一个，成本因素。
第二个，业务容忍度。
第三个，系统当前的稳定性状况。

## 03 | SRE切入点：选择SLI，设定SLO

SRE 强调的稳定性，一般不是看单次请求的成功与否，而是看整体情况，所以我们会把成功请求的占比设定为一个可以接受的目标，也就是我们常说的“3 个 9”或“4 个 9”这样的可量化的数字。

那么，这个“确定成功请求条件，设定达成占比目标”的过程，在 SRE 中就是设定稳定性衡量标准的 SLI 和 SLO 的过程。

具体来看下这两个概念。SLI，Service Level Indicator，服务等级指标，其实就是我们选择哪些指标来衡量我们的稳定性。而 SLO，Service Level Objective，服务等级目标，指的就是我们设定的稳定性目标，比如“几个 9”这样的目标。

SLI 和 SLO 这两个概念你一定要牢牢记住，接下来我们会反复讲到它们，因为落地 SRE 的第一步其实就是“选择合适的 SLI，设定对应的 SLO”。

### SLI 和 SLO 到底是啥？

在 SRE 实践中，我们用 SLI 和 SLO 来描述。“状态码为非 5xx 的比例”就是 SLI，“大于等于 99.95%”就是 SLO。说得更直接一点，SLO 是 SLI 要达成的目标。

通过这个例子，你现在是不是已经理解了这两个概念呢。SLI 就是我们要监控的指标，SLO 就是这个指标对应的目标。

### 系统运行状态指标那么多，哪些适合SLI？

https://static001.geekbang.org/resource/image/e8/9c/e8a49d7fbfb8df42db84efe44f48f59c.jpg

根据这几年的实践经验，我总结了选择 SLI 指标的两大原则。

原则一：选择能够标识一个主体是否稳定的指标，如果不是这个主体本身的指标，或者不能标识主体稳定性的，就要排除在外。

原则二：针对电商这类有用户界面的业务系统，优先选择与用户体验强相关或用户可以明显感知的指标。

### 快速识别 SLI 指标的方法：VALET

VALET 是 5 个单词的首字母，分别是 Volume、Availability、Latency、Error 和 Ticket。这 5 个单词就是我们选择 SLI 指标的 5 个维度。

Volume- 容量，Availablity- 可用性，Latency- 时延，Errors- 错误率，Tickets- 人工介入

### 如何通过 SLO 计算可用性？

第一种，直接根据成功的定义来计算。
第二种方式，SLO 方式计算。

### 总结

对系统相关指标要分层，识别出我们要保障稳定性的主体（系统、业务或应用）是什么，然后基于这个主体来选择合适的 SLI 指标。

不是所有的指标都是适合做 SLI 指标，它一定要能够直接体现和反映主体的稳定性状态。可以优先选择用户或使用者能感受到的体验类指标，比如时延、可用性、错误率等。

掌握 VALET 方法，快速选择 SLI 指标。

## 04 | 错误预算：达成稳定性目标的共识机制

没错，SRE 还真是这么做的，这个概念叫做 Error Budget，翻译过来就是错误预算。

错误预算其实和驾照记分制是一样的，最大的作用就是“提示你还有多少次犯错的机会”，并且，错误预算的警示效果比看成功率这种统计数据更直观，感官冲击力更强。

你看，错误预算的计算很简单，起到的警示效果又更强烈，所以在 SLO 落地实践时，我们通常就把 SLO 转化为错误预算，以此来推进稳定性目标达成。

### 如何应用 Error Budget？

1. 稳定性燃尽图
2. 故障定级
3. 稳定性共识机制
4. 基于错误预算的告警

### 如何衡量 SLO 的有效性？

SLO 达成情况。
“人肉”投入程度。
用户满意度。

## 05 | 案例：落地SLO时还需要考虑哪些因素？

### 设定 SLO 有哪些原则？

第一，核心应用的 SLO 要更严格，非核心应用可以放宽。
第二，强依赖之间的核心应用，SLO 要一致。
第三，弱依赖中，核心应用对非核心的依赖，要有降级、熔断和限流等服务治理手段。
第四，Error Budget 策略，核心应用的错误预算要共享，就是如果某个核心应用错误预算消耗完，SLO 没有达成，那整条链路，原则上是要全部暂停操作的，因为对于用户来说，他不会判断是因为哪个应用有问题，导致的体验或感受不好。

### 如何验证核心链路的 SLO？

容量压测
Chaos Engineering- 混沌工程
- 混沌工程是 SRE 稳定性体系建设的高级阶段

### 应该在什么时机做系统验证？

核心就是错误预算充足就可以尝试，尽量避开错误预算不足的时间段。因为在正常业务下，我们要完成 SLO 已经有很大的压力了，不能再给系统稳定性增加新的风险。

### 总结

今天我们结合一个电商案例，讨论了在落地 SLO 时还要考虑的一些实际因素。你需要重点掌握以下 4 点：

1. 先设定核心链路的 SLO，然后根据核心链路进行 SLO 的分解。
2. 确定一个系统的核心链路，关键是确认核心应用和非核心应用，以及强弱依赖关系。这个过程在初始执行时，需要大量人工投入和分析，但是这个过程不能忽略。
3. 强依赖的核心应用 SLO 必须与核心链路 SLO 一致，弱依赖的非核心应用 SLO 可以降低，但是必须要有对应的限流降级等服务治理手段。
4. 通过容量压测和混沌工程等手段，对上述过程进行验证，但是一定要在错误预算充足的情况下执行。

