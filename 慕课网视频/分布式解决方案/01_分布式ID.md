# 分布式ID

https://tech.meituan.com/2017/04/21/mt-leaf.html

在复杂分布式系统中，往往需要对大量的数据和消息进行唯一标识。如在美团点评的金融、支付、餐饮、酒店、猫眼电影等产品的系统中，数据日渐增长，对数据分库分表后需要有一个唯一ID来标识一条数据或消息，数据库的自增ID显然不能满足需求；特别一点的如订单、骑手、优惠券也都需要有唯一ID做标识。此时一个能够生成全局唯一ID的系统是非常必要的。

## 传统方案

时间戳，UUID

## 分布式ID特点

- 全局唯一
- 高并发
- 高可用

一个应用在一台服务器，ID唯一
相同应用在多台服务器，ID唯一
多个应用在一台服务器生产的ID唯一？不需要
运行在docker容器里生成的ID唯一

## 实现方案

UUID
- 缺点：空间占用较多
- 不能生成递增有序的数字，索引效率下降

数据库主键自增
- 缺点：并发性能不高，受限于数据库性能
- 分库分表，需改造，较复杂
- 自增：数据量泄露

Redis自增
- 优点：相对于MySQL，并发性能会高很多
- 缺点：数据丢失
- 自增：数据量泄露

雪花算法：
- 缺点：时钟回拨

方案总结：
- 号段模式
    - 1..100,101..200
    - 性能提高，自增
- 雪花算法
    - 我们怎么做，时间戳（毫秒）+ 随机数，但这样容易重，考虑把随机数换成自增数（Automic，而不是i++），能解决单台，但是不能解决多台服务器，于是加机器号
    - 1bit符号位+41bit时间戳位+10bit工作进程位（5+5,区域+服务器标识）+12bit序列号位
    - 这些位数都可以根据实际情况改
    - 时间69年，工作进程数量1024，序列号数量4096

## 开源组件

百度（uid-generator）
滴滴（Tinyid）
美团（Leaf），同时支持号段和雪花算法

模拟：
号段模式
100044
100045
100046
自增

雪花算法：
128588494612323232
后面的比前面的大

百度的uid-generator只支持雪花算法，已经很久没人维护了，直接pass掉
tinyid只支持数据库号段，多DB，高可用
美团的leaf，提供号段和雪花算法两种模式，号段也是数据库的号段。雪花用到了zookeeper，服务器标识是最难的标识，程序会上报服务器标识到zk，zk储存。

滴滴：tinyid，适合对id有高可用需求
美团：适合多种场景分布式id

## 实战环节

不知道为什么，我的包安装不上

号段算法，取出1后，不会再去重新请求数据库了
重启程序后，假设步长为2000，后面就从2001开始
数据库max_id变成4001，步长2000

提前加载，没有等到用完了去加id

biz_id就是key

接下来看雪花算法

zkui，zk的可视化的管理端



