# 多进程编程

## 绕过GIL

一个进程——一个解释器——一个GIL

进程的线程共享进程资源
进程间的资源不共享

countdown程序：
多线程，时间翻倍
多进程，时间只是多一秒（进程间切换）

查看cpu占用率程序
sar -u l 100
多进程真正的并行了起来，占满了CPU的两个核

## 多进程高级编程

父进程内存空间
- 子进程1内存空间
- 子进程2内存空间

python底层是fork底层调用

子进程拷贝父进程内存数据

Queue在底层是共享内存的
使用Queue来实现进程间通信
python-process-queue.py
queue = multiprocessing.Queue()
如果不用Queue,就把cnt当做参数传进进程里，是不行的
queue的变量是属于父进程的
而传cnt会在每个进程初始化cnt

## 进程池使用

ProcessPoolExecutor

什么是进程池
- 进程池是存放多个进程的容器
- CPU调度进程执行后不会销毁进程
- 将进程放回进程池重复利用

为什么使用进程池
- 进程是稀缺资源，不应该频繁创建和销毁
- 架构解耦，进程创建和业务处理解耦，更加优雅
- 进程池是Python使用多进程的最佳时间

from concurrent.futures import ProcessPoolExecutor

进程池和线程池体现了几乎一致的接口

## 多进程优化图片下载器

多进程executor

### 量化分析对比

哈希模块提升了37.78%
网络和存储模块，多进程相比于多线程优化不明显

结论
- 多进程相比多线程有明显优化效果
- 多进程对CPU哈希模块有明显优化效果
- 除CPU哈希模块，多进程优化效果不及多线程优化效果

## 多进程局限性

### 什么是上下文切换

switch-time-test.py 上下文切换成本测试

sar -w l 1000 统计上下文切换的次数
大概在每秒4w左右，程序耗时7s

多线程程序只耗时了3s左右

进程对于操作系统来说是一个很重的个体

进程切换的成本大于线程切换的成本

- 使用多进程需要考虑多进程切换的成本
- 多进程上下文切换的成本远大于多线程上下文切换的成本

## CPU核数、并发数与性能的关系

### 统筹方法

进程间隔离的，一个进程有多个线程，共享进程资源

华罗庚的统筹方法

PIC

### 阿姆达定律

理论最大加速比

S(N) = 1 / （(1-P) + P/N）

N：N个处理核
P: 可加速时间占比

线程越多，性能越好？
- 线程数和CPU核是有关系的
    - CPU密集型：N+1
    - IO密集型：2N+1
- 线程过多会引起线程之间竞争CPU
- 线程过多频繁切换成本高

