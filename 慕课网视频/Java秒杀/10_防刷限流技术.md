# 防刷限流技术

## 验证码

包装秒杀令牌前置，需要验证码来错峰
数学公式验证码生成器

## 限流目的

- 流量远比你想的要多
- 系统活着比挂了要好
- 宁愿只让少数人能用，也不要让所有人不能用

## 限流方案

- 限并发（全局的计数器，支持并发下减和加，在入口和出口加和减，如果变成负的，就不去处理请求）
- 令牌桶算法（有个定时器，每秒往桶里发送10个令牌，客户端每次去获取令牌）（限制某一秒流量的最大值，不能超过特定值）（互联网行业，用的最多的还是令牌桶算法）（互联网需要应对突发流量）
- 漏桶算法（桶，10份水是满的，每秒以一滴水的速度流出，客户端加一滴水）（平滑网络流量以固定速率流入）

## 限流粒度

- 接口维度
- 总维度

## 限流范围

- 集群限流：依赖redis或其他的中间件技术做统一计数器，往往会产生性能瓶颈
- 单机限流：负载均衡的前提下单机平均限流效果更好（通常情况下会使用单机的限流）

## 限流

代码实现
RateLimiter

## 防刷

- 排队，限流，令牌均只能控制总流量，无法控制黄牛流量

## 传统防刷

- 限制一个会话（session_id,token）统一秒钟/分钟接口调用多少次：多会话接入绕开无效
- 限制一个ip同一秒钟/分钟 接口调用多少次：数量不好控制，容易误伤

## 黄牛为什么难防
- 模拟器作弊：模拟硬件设备，可修改设备信息
- 设备牧场作弊：工作室里一批移动设备
- 人工作弊：靠佣金吸引兼职人员刷单

## 设备指纹
- 采集终端设备各项参数，启动应用时生成唯一设备指纹
- 根据对应设备指纹的参数猜测出模拟器等可疑设备概率

## 凭证系统
- 根据设备指纹下发凭证
- 关键业务链路上带上凭证并由业务系统到凭证服务器上验证
- 凭证服务器根据对于凭证所等价的设备指纹参数并根据实时行为风控系统判断对应凭证的可疑度分数
- 若分数低于某个数值则由业务系统返回固定错误码，拉起前端验证码验身，验身成功后加入凭证服务器对应分数

