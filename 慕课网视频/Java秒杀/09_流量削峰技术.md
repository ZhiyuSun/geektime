# 流量削峰技术

## 秒杀令牌的原理和使用方式

- 秒杀接口需要依靠令牌才能进入
- 秒杀的令牌由秒杀活动模块负责生成
- 秒杀活动模块对秒杀令牌生成全权处理，逻辑收口
- 秒杀下单前需要先获得秒杀令牌

前端先拿到令牌，下单的时候验证令牌
令牌根据获得id，用户id，商品id生成

缺陷：
秒杀令牌只要活动一开始就无限制生成，影响系统性能


## 掌握秒杀大闸的原理和使用方式

- 依靠秒杀令牌的授权原理定制化发牌逻辑，做到大闸功能
- 根据秒杀商品初始库存颁发对于数量令牌，控制大闸流量
- 用户风控策略前置到秒杀令牌发放中
- 库存售罄判断前置到秒杀令牌发放中

将大闸限制数字设到redis里

缺陷：
- 浪涌流量涌入后系统无法应对
- 多库存，多商品等令牌限制能力弱

## 队列泄洪原理

- 排队有些时候比并发更高效（例如redis单线程模型，innodb mutex key等）
- 依靠排队去限制并发流量
- 依靠排队和下游拥塞窗口程度调整队列释放流量大小
- 支付宝银行网关队列举例（下游的qps低，保护下游）

（有时候把redis绑定在固定一个cpu上，连线程上下文切换开销都没有了）

Excutors
拥塞窗口为20的等待队列，用来队列化泄洪

本地or分布式
- 本地：将队列维护在本地内存中
- 分布式：将队列设置到外部redis内

推荐本地队列