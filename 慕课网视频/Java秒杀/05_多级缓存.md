# 多级缓存

## 缓存设计

用快速存取设备，用内存
将缓存推到离用户最近的地方
脏缓存清理

## 多级缓存

### redis缓存

集中式的缓存节点

单机版
sentinel哨兵模式
- 根据心跳，指定哪个是master，统一管理master和slave的切换
集群cluster模式

### 热点内存本地缓存
- 热点数据
- 脏读非常不敏感
- 内存可控

gruva cache
- 可控制的大小和超时时间
- 可配置的lru策略
- 线程安全

### nginx proxy cache缓存

- nginx反向代理前置
- 依靠文件系统存索引级的文件
- 依靠内存缓存文件地址

（从磁盘读写）

### nginx lua缓存

- lua协程机制
- nginx协程机制
- nginx lua插载点

#### 协程机制
- 依附于线程的内存模型，切换开销小
- 遇阻塞及归还执行权，代码同步
- 无需加锁

#### nginx协程
- nginx的每一个worker进程都是在epoll或kqueue这种事件模型之上，封装成协程
- 每一个请求都有一个协程进行处理
- 技术nginx_lua须要运行Lua，相对C有一定的开销，但依旧能保证高并发能力

#### nginx协程机制

- nginx每个工作进程创建一个lua虚拟机
- 工作进程内的所有协程共享同一个vm
- 每个外部请求由一个lua协程处理，之间数据隔离
- lua代码调用io等异步接口时，协程被挂起，上下文数据
- 自动保存，不阻塞工作进程
- io异步操作完成后还原协程上下文，代码继续执行

