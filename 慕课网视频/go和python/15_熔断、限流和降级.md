# 熔断，限流，降级

服务雪崩效应是一种因服务提供者的不可用，导致服务调用者不可用，并将不可用主键放大的现象。

服务雪崩可以分为三个阶段
- 服务提供者不可用
- 重试加大请求流量
- 服务调用者不可用


服务雪崩原因
- 服务不可用
    - 硬件故障
    - 程序bug
    - 缓存击穿
    - 用户大量请求
- 重试加大流量
    - 用户重试
    - 代码逻辑重试
- 服务调用者不可用
    - 同步等待造成的资源耗尽

应对策略：
- 应用扩容
    - 增加机器数量
    - 升级硬件规格
- 流控
    - 限流（多出来的流量，1拒绝，2 排队等待，用户体验不好：当前访问用户过多，请稍后重试。用户体验降级-原本是访问流畅，下单流畅——当前访问用户过多，请稍后重试）
    - 关闭重试
- 缓存
    - 缓存预加载
- 服务降级
    - 服务接口拒绝服务
    - 页面拒绝服务
    - 延迟持久化
    - 随机拒绝服务
- 服务熔断


A访问B，这时候B服务很慢-B服务压力过大，导致了出现不少请求错误，调用方很容易出现一个问题：每次调用都超时2k，结果这个是时候数据库出现了错误，超时重试。网络2k的流量突然变成了3k，这让原本就满负荷的b服务雪上加霜，如果这时候调用方有一种机制——比如说：1发现了大部分请求很慢。2发现我的请求有50%都错了，3错误数量很多，例如1s出现了20个错误
熔断——1. 保险丝，2.股市熔断

## 熔断限流技术选型

sentinel和hytrixs对比

sentinel-golang

基于qps限流
Threshold 1000
StatIntervalInMs 5000

预热冷启动
warmUpPeriodSec 预热时间长度
防止流量瞬间暴增

controlBahavior
throtting 匀速通过

sentinel里面也有熔断的功能

熔断演示

基于错误数
基于错误比率

gin中集成sentinel

sentinel暂时不支持python

熔断，三个状态
closed halfopen open

python的熔断库：

pybreaker

限流库：ratelimit




