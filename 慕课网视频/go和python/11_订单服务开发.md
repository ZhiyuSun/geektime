# 订单服务开发

## 1. 建model

订单表
订单商品表
- 存商品图片，价格，镜像

## 2. 定义proto

google.protobuf.Empty 修改的返回

## 3. 项目的其他部分

handler,setting,nacos

## 4. 写接口

创建购物车，需要合并已经存在的记录

更新购物车状态

删除购物车

## 5. 写订单的接口

订单列表，订单详情，订单状态

新建订单（非常复杂的逻辑）
- 价格-访问商品服务
- 库存的扣减-访问库存服务
- 订单基本信息表，订单的商品信息表
- 从购物车中获取选中的商品
- 从购物车中删除已购买的商品

consul.py里面的filter_service，get_host_port，去拿服务

构成grc的channel
grpc.insecure_channel()

把goods.proto拷贝过来

grpc底层支持了dns的resolver
但是python的grpc还做的不到位，所以自己实现

把库存的proto文件也复制过来

创建订单逻辑编写

要把整个过程在事务中完成，但其实已经调用了其他服务，跨服务了
扣减服务跨服务了暂时管不到
但是创建订单可以先用with做回滚，trycatch捕获异常，并且在exception里rollback

test/order.py里面的代码可以重点学习一下

调用接口，使用order_pb2_grpc.OrderStub(channel)

## 6. 订单服务的web层开发

order-web

srv_conn.go 连接各个服务

## 7. 写web层具体的业务逻辑

购物车列表页

添加商品到购物车
调用库存服务，检查库存

删除商品

interface断言，userId.(uint) ??

更新购物车

订单列表页

ctx.get("userId") 可以拿用户

订单详情接口

strconv.Atoi(id)

request := proto.OrderRequest{
    Id：int32(i)
}
global.OrderSrvClient.OrderDetail(context.Background(), &request)

??
好像不知道类型，可以定义为interface
goods := make([]interface{}, 0)

ctx.ShouldBindJSON(&orderForm)
表单验证

创建订单完，要返回支付宝支付的url

